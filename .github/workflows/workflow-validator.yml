name: Workflow Validator with AI Suggestions

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'

jobs:
  validate-workflows:
    name: Validate Workflows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download and install actionlint
        run: |
          # Download latest actionlint binary
          curl -sSL https://github.com/rhysd/actionlint/releases/latest/download/actionlint_linux_amd64.tar.gz | tar xz
          sudo mv actionlint /usr/local/bin/
          actionlint --version

      - name: Install Python dependencies for AI suggestions
        if: github.event_name == 'pull_request'
        run: |
          pip install anthropic

      - name: Run actionlint
        id: actionlint
        continue-on-error: true
        run: |
          set +e
          actionlint -color -verbose > actionlint-output.txt 2>&1
          RESULT=$?
          set -e
          echo "exit_code=$RESULT" >> "$GITHUB_OUTPUT"

          # Show output
          if [ -f actionlint-output.txt ]; then
            cat actionlint-output.txt
          fi

      - name: Generate AI fix suggestions
        id: ai-suggestions
        if: steps.actionlint.outputs.exit_code != '0' && github.event_name == 'pull_request'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys
          from pathlib import Path

          # Add scripts to path
          sys.path.insert(0, str(Path.cwd() / 'scripts'))

          from workflow_utils.validate_and_fix import (
              parse_actionlint_output,
              suggest_fixes_with_ai,
          )

          # Read actionlint output
          with open('actionlint-output.txt') as f:
              output = f.read()

          # Parse errors
          errors = parse_actionlint_output(output)

          if not errors:
              print("No errors to fix")
              sys.exit(0)

          # Get workflow files that have errors
          workflow_files = list(set(err['file'] for err in errors))

          # Generate suggestions for each file
          all_suggestions = []
          for workflow_file in workflow_files:
              file_errors = [e for e in errors if e['file'] == workflow_file]

              try:
                  with open(workflow_file) as f:
                      workflow_content = f.read()

                  suggestions = suggest_fixes_with_ai(file_errors, workflow_content)
                  if suggestions:
                      all_suggestions.append(f"## {workflow_file}\n\n{suggestions}")
              except FileNotFoundError:
                  print(f"Warning: File not found: {workflow_file}")

          # Save suggestions
          if all_suggestions:
              with open('ai-suggestions.md', 'w') as f:
                  f.write("# AI-Suggested Workflow Fixes\n\n")
                  f.write("\n\n---\n\n".join(all_suggestions))
              print("AI suggestions generated successfully")
          else:
              print("No AI suggestions generated")
          EOF

      - name: Post AI suggestions to PR
        if: steps.actionlint.outputs.exit_code != '0' && github.event_name == 'pull_request' && hashFiles('ai-suggestions.md') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = '## ðŸ¤– Workflow Validation Results\n\n';
            body += 'âš ï¸ actionlint found issues in the workflow files.\n\n';

            // Add AI suggestions if available
            if (fs.existsSync('ai-suggestions.md')) {
              const suggestions = fs.readFileSync('ai-suggestions.md', 'utf8');
              body += suggestions;
              body += '\n\n---\n\n';
            }

            body += '<details>\n<summary>View full actionlint output</summary>\n\n';
            body += '```\n';
            const output = fs.readFileSync('actionlint-output.txt', 'utf8');
            body += output.substring(0, 8000);  // Limit size
            body += '\n```\n</details>\n\n';

            body += '\n*Suggestions generated by Claude Sonnet 4.5*';

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Generate workflow validation summary
        if: always()
        run: |
          if [ "${{ steps.actionlint.outputs.exit_code }}" = "0" ]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## âœ… Workflow Validation Passed

          All GitHub Actions workflows are valid!

          **Checks performed:**
          - YAML syntax validation
          - Action input/output validation
          - Shell script validation (shellcheck)
          - Expression syntax validation
          - Job dependency validation
          EOF
          else
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## âŒ Workflow Validation Failed

          actionlint found issues in the workflow files.

          **What to do:**
          1. Review the errors in the job output above
          2. If this is a PR, check the AI-suggested fixes in the PR comment
          3. Fix the issues and push the changes
          4. Or run locally: `python scripts/workflow_utils/validate_and_fix.py --ai-suggest`

          **Install actionlint locally:**
          ```bash
          # macOS
          brew install actionlint

          # Linux
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/install.sh)
          ```
          EOF

            if [ -f actionlint-output.txt ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "### Errors" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              cat actionlint-output.txt >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Upload actionlint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: actionlint-results
          path: |
            actionlint-output.txt
            ai-suggestions.md

      - name: Fail if validation failed
        if: steps.actionlint.outputs.exit_code != '0'
        run: |
          echo "Workflow validation failed. Please fix the issues above."
          exit 1
