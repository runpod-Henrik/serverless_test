================================================================================
CI/CD INTEGRATION SETUP STEPS
Automatic Flaky Test Detection on Test Failures
================================================================================

STEP 1: ADD GITHUB SECRETS
---------------------------
Go to: https://github.com/runpod-Henrik/serverless_test/settings/secrets/actions

Click "New repository secret" and add these three secrets:

1. Name: RUNPOD_API_KEY
   Value: <your RunPod API key here>
   (Get from: https://www.runpod.io/console/user/settings)

2. Name: RUNPOD_ENDPOINT_ID
   Value: <your endpoint ID here>
   (From your RunPod serverless endpoint)

3. Name: SLACK_WEBHOOK_URL (optional)
   Value: Your Slack webhook URL
   (Only if you want Slack notifications)


STEP 2: UPDATE WORKFLOW TRIGGER (if needed)
--------------------------------------------
Edit: .github/workflows/flaky-test-detector.yml
Line 4: Change "CI" to match your test workflow name

Example:
  workflows: ["CI"]  # Replace "CI" with your actual workflow name

To find your workflow name:
- Look at your test workflow file (e.g., .github/workflows/test.yml)
- Find the "name:" field at the top


STEP 3: GET SLACK WEBHOOK (optional)
-------------------------------------
For Slack notifications:

1. Go to your Slack workspace
2. Navigate to: Settings & administration â†’ Manage apps
3. Search for "Incoming Webhooks" and add it
4. Click "Add to Slack"
5. Choose a channel (e.g., #ci-notifications)
6. Copy the Webhook URL
7. Add it as SLACK_WEBHOOK_URL secret in GitHub

For Discord:
1. Go to Server Settings â†’ Integrations â†’ Webhooks
2. Click "New Webhook"
3. Name it "Flaky Test Detector"
4. Choose a channel
5. Copy webhook URL and append "/slack" to the end:
   Example: https://discord.com/api/webhooks/xxx/yyy/slack
6. Add as SLACK_WEBHOOK_URL secret in GitHub


STEP 4: TEST THE INTEGRATION
-----------------------------
To test that everything works:

1. Create a test branch:
   git checkout -b test-flaky-detection

2. Make a test fail (edit tests/test_flaky.py):
   Change line 22 from:
     success_threshold = 0.18
   To:
     success_threshold = 0.01  # Will fail almost always

3. Commit and push:
   git add tests/test_flaky.py
   git commit -m "Test flaky detector"
   git push -u origin test-flaky-detection

4. Create a pull request on GitHub

5. Wait for CI to fail

6. Flaky test detector should automatically:
   - Trigger after CI failure
   - Run tests 100 times on RunPod
   - Post results as PR comment
   - Send Slack notification (if configured)

7. Check for:
   - PR comment with severity indicator
   - Slack notification
   - Workflow run in Actions tab


STEP 5: CLEANUP TEST
---------------------
After testing:
1. Close the test PR
2. Delete the test branch
3. Revert changes to tests/test_flaky.py if needed


WHAT HAPPENS AUTOMATICALLY
---------------------------
Once configured, whenever CI tests fail:

1. GitHub Actions detects the failure
2. Flaky test detector workflow triggers
3. Job is submitted to RunPod endpoint
4. Tests run 100x in parallel (configurable)
5. Results analyzed for flaky patterns
6. PR comment posted with:
   - Severity level (ðŸ”´ðŸŸ ðŸŸ¡ðŸŸ¢âœ…)
   - Failure statistics
   - Table of failed runs
   - Recommendations
7. Slack notification sent (if configured)
8. Detailed results saved as artifact


SEVERITY LEVELS
---------------
ðŸ”´ CRITICAL (>90% failure) - Real bug, not flaky
ðŸŸ  HIGH (50-90% failure)   - Very unstable, fix before merge
ðŸŸ¡ MEDIUM (10-50% failure) - Flaky test, should fix
ðŸŸ¢ LOW (1-10% failure)     - Occasional flakiness
âœ… NONE (0% failure)       - One-time issue, safe to merge


CONFIGURATION OPTIONS
---------------------
You can customize the workflow in:
.github/workflows/flaky-test-detector.yml

Environment variables you can adjust:
- FLAKY_TEST_RUNS: Number of test runs (default: 100)
- FLAKY_TEST_PARALLELISM: Parallel workers (default: 10)


TROUBLESHOOTING
---------------
If workflow doesn't trigger:
1. Check workflow name matches in line 4
2. Verify secrets are added correctly
3. Check GitHub Actions permissions:
   Settings â†’ Actions â†’ General â†’ Allow workflows

If no PR comment:
1. Verify GITHUB_TOKEN has pull-requests: write permission
2. Check workflow logs for errors

If Slack notifications fail:
1. Test webhook URL with curl:
   curl -X POST -H 'Content-type: application/json' \
     --data '{"text":"Test"}' YOUR_WEBHOOK_URL
2. Check webhook URL is correct in secrets


COST INFORMATION
----------------
RunPod endpoint configuration:
- Image: henrikbae/flaky-test-detector:latest
- Type: CPU (most cost-effective for tests)
- Min Workers: 0 (scales to zero when idle)
- Max Workers: 3-5 (adjust based on usage)
- Idle Timeout: 30 seconds

Estimated costs:
- Idle: $0/hour (scales to zero)
- Active: ~$0.0002/second per worker
- Typical test run (100 tests, 2 min): ~$0.024


SUPPORT & DOCUMENTATION
-----------------------
- Full CI/CD guide: docs/CICD_INTEGRATION.md
- Deployment guide: DEPLOYMENT.md
- Main README: README.md
- Development guide: CLAUDE.md

Repository: https://github.com/runpod-Henrik/serverless_test

================================================================================
DEPLOYMENT COMPLETE - READY FOR AUTOMATIC FLAKY TEST DETECTION
================================================================================
